import os
import logging
from typing import List

"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ data/ –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞.
–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º –ø—É—Ç–∏ /data/.

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è SERVER_ENV=production.
"""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞
BOT_TOKEN = os.environ.get("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN")

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ ADMIN_IDS –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏-–∑–∞–ø—è—Ç—ã–º–∏ –≤ —Å–ø–∏—Å–æ–∫ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
ADMIN_IDS: List[int] = [
    int(id_str.strip()) 
    for id_str in os.environ.get("ADMIN_IDS", "").split(",") 
    if id_str.strip().isdigit()
] or [100116667, 908546990]  # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ admin IDs

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
PHONE_PAY = os.environ.get("PHONE_PAY", "7 920 132 2534")
NAME_PAY = os.environ.get("NAME_PAY", "–î–∏–∞–Ω–∞ –ò–±—Ä–∞–≥–∏–º–æ–≤–Ω–∞ –†—ã–∂–æ–≤–∞")

# –õ–æ–≥–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
logger.info(f"PHONE_PAY: {PHONE_PAY}")
logger.info(f"NAME_PAY: {NAME_PAY}")

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω –∫–æ–¥ - –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
is_server = os.environ.get("SERVER_ENV") == "production"

# –í—ã–±–∏—Ä–∞–µ–º –ø—É—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è
if is_server:
    DATA_DIR = "/data"  # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
else:
    DATA_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), "data")  # –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DATA_DIR: {DATA_DIR} ({'—Å–µ—Ä–≤–µ—Ä' if is_server else '–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞'})")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ data –∏ —Å–æ–∑–¥–∞–µ–º –µ—ë –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
if not os.path.exists(DATA_DIR):
    os.makedirs(DATA_DIR)

DB_PATH = os.path.join(DATA_DIR, "birthday_bot.db")
SCHEMA_PATH = os.path.join(DATA_DIR, "db_schema.sql")

# –õ–æ–≥–∏—Ä—É–µ–º –ø—É—Ç–∏
logger.info(f"DB_PATH: {DB_PATH}")
logger.info(f"SCHEMA_PATH: {SCHEMA_PATH}")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_NOTIFICATION_SETTINGS = [
    {
        "days_before": 3,
        "time": "10:00",
        "template": """<b>–ü—Ä–∏–≤–µ—Ç!</b> üëã

<i>{date}</i> –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É <b>{name}</b>. –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω–æ–º –∫–æ–Ω–≤–µ—Ä—Ç–µ, –ø—Ä–æ—à—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤–∑–Ω–æ—Å –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ <code>{phone_pay}</code> –Ω–∞ –ê–ª—å—Ñ—É –∏–ª–∏ –¢–∏–Ω—å–∫–æ—Ñ—Ñ –¥–æ <i>{date_before}</i>.

<b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> {name_pay}.

‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ –¥–µ–Ω—å–≥–∏ –≤ –¥—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã.
–í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏ ¬´<code>–î–† {name}</code>¬ª."""
    },
    {
        "days_before": 1,
        "time": "09:00",
        "template": """<b>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ! ‚è∞</b>

<i>–ó–∞–≤—Ç—Ä–∞, {date}</i>, –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É <b>{name}</b>. 

–ï—Å–ª–∏ —Ç—ã –µ—â–µ –Ω–µ –ø–µ—Ä–µ–≤–µ–ª(–∞) –¥–µ–Ω—å–≥–∏ –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫, —Å–∞–º–æ–µ –≤—Ä–µ–º—è —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å!
‚Ä¢ –ù–æ–º–µ—Ä: <code>{phone_pay}</code>
‚Ä¢ –ë–∞–Ω–∫–∏: –ê–ª—å—Ñ–∞ –∏–ª–∏ –¢–∏–Ω—å–∫–æ—Ñ—Ñ
‚Ä¢ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: <i>{name_pay}</i>
‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: <code>–î–† {name}</code>"""
    },
    {
        "days_before": 0,
        "time": "09:00",
        "template": """<b>üéÇ –° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è!</b>

–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É <b>{name}</b>.
–ù–µ –∑–∞–±—É–¥—å –ø–æ–∑–¥—Ä–∞–≤–∏—Ç—å!"""
    }
]