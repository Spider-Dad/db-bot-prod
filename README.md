# Telegram Birthday Bot

Telegram бот для управления и отправки напоминаний о днях рождения с функциями администрирования.


## Основные возможности

- Отображение списка дней рождения с группировкой по месяцам на русском языке
- Комплексное управление базой данных пользователей и их настройками
- Автоматическое создание резервных копий с возможностью восстановления
- Система администрирования с расширенными командами
- Настраиваемые шаблоны уведомлений с HTML-форматированием
- Управление подписками пользователей на уведомления
- Интеллектуальная система рассылки напоминаний
- Защита от множественных запусков бота
- Система кэширования для оптимизации отправки уведомлений

## Структура проекта

```
├── bot/
│   ├── __init__.py         # Инициализация пакета бота
│   ├── constants.py        # Константы и конфигурации
│   ├── core/               # Ядро приложения
│   │   ├── __init__.py     # Инициализация пакета core
│   │   ├── base_repository.py # Базовый класс репозитория
│   │   ├── base_service.py    # Базовый класс сервиса
│   │   ├── interfaces.py      # Интерфейсы для классов
│   │   └── models.py          # Модели данных
│   ├── handlers/           # Обработчики команд
│   │   ├── __init__.py     # Инициализация пакета handlers
│   │   ├── base_handler.py # Базовый класс обработчика
│   │   ├── user_handler.py # Обработчик команд пользователей
│   │   ├── template_handler.py # Обработчик шаблонов
│   │   ├── notification_setting_handler.py # Обработчик настроек
│   │   ├── notification_log_handler.py    # Обработчик логов
│   │   ├── backup_handler.py # Обработчик резервных копий
│   │   ├── game_handler.py  # Обработчик игровых команд
│   │   └── decorators.py   # Декораторы для обработчиков
│   ├── repositories/       # Доступ к данным
│   │   ├── __init__.py     # Инициализация пакета repositories
│   │   ├── database_manager.py # Управление базой данных
│   │   ├── user_repository.py # Репозиторий пользователей
│   │   ├── template_repository.py # Репозиторий шаблонов
│   │   └── notification_setting_repository.py # Репозиторий настроек
│   ├── services/           # Бизнес-логика
│   │   ├── __init__.py     # Инициализация пакета services
│   │   ├── user_service.py # Сервис пользователей
│   │   ├── template_service.py # Сервис шаблонов
│   │   ├── notification_setting_service.py # Сервис настроек
│   │   ├── notification_log_service.py    # Сервис логирования
│   │   ├── backup_service.py # Сервис резервных копий
│   │   └── notification_service.py # Сервис отправки уведомлений
│   └── utils/              # Вспомогательные утилиты
│       ├── __init__.py     # Инициализация пакета utils
│       ├── formatters.py   # Функции форматирования
│       ├── validators.py   # Функции валидации
│       └── keyboard_manager.py # Утилиты для клавиатур
├── data/                   # Директория данных
│   ├── birthday_bot.db     # База данных SQLite
│   ├── db_schema.sql       # Схема базы данных
│   ├── bot.lock            # Файл блокировки
│   └── backups/            # Резервные копии
├── config.py               # Конфигурация приложения
├── main.py                 # Точка входа
├── requirements.txt        # Зависимости проекта
└── .env                    # Переменные окружения
```

## Команды

### Пользовательские команды
- `/start` - Запустить бота и подтвердить подписку на уведомления
- `/birthdays` - Показать список дней рождения с группировкой по месяцам
- `/menu` - Отобразить главное меню

### Административные команды
#### Управление пользователями
- `/add_user` - Добавить пользователя в систему
- `/remove_user` - Удалить пользователя из системы
- `/toggle_notifications` - Управление уведомлениями пользователя
- `/users` - Просмотр справочника пользователей
- `/set_admin` - Назначить пользователя администратором
- `/remove_admin` - Отозвать права администратора

#### Управление шаблонами и уведомлениями
- `/get_templates` - Просмотр списка шаблонов
- `/set_template` - Добавить новый шаблон
- `/update_template` - Обновить существующий шаблон
- `/preview_template` - Предпросмотр шаблона
- `/delete_template` - Удалить шаблон
- `/activate_template` - Активировать шаблон
- `/deactivate_template` - Деактивировать шаблон
- `/help_template` - Помощь по шаблонам
- `/menu_templates` - Меню работы с шаблонами

#### Управление настройками
- `/get_settings` - Просмотр настроек уведомлений
- `/set_setting` - Добавить настройку уведомлений
- `/edit_setting` - Изменить настройку уведомлений
- `/delete_setting` - Удалить настройку уведомлений
- `/force_notify` - Отправить тестовое уведомление
- `/menu_settings` - Меню работы с настройками

#### Управление резервными копиями
- `/backup` - Создать резервную копию базы данных
- `/list_backups` - Показать список доступных резервных копий
- `/restore` - Восстановить базу из резервной копии
- `/menu_backup` - Меню работы с резервными копиями

## Технические характеристики

- Python 3.11
- PyTelegramBotAPI (telebot)
- SQLite для хранения данных
- HTML форматирование сообщений
- Архитектура на основе принципов SOLID
- Многоуровневая архитектура (репозитории, сервисы, обработчики)
- Автоматическое резервное копирование
- Локализация на русский язык
- Механизм блокировки для предотвращения множественных запусков

## Установка и запуск

1. Клонируйте репозиторий:
```bash
git clone [URL репозитория]
```

2. Создайте виртуальное окружение и активируйте его:
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте .env файл с переменными окружения:
```
BOT_TOKEN=your_bot_token
ADMIN_IDS=id1,id2,id3
SERVER_ENV=production
PHONE_PAY=7 123 456 7890
NAME_PAY=Имя Получателя Платежа
```

5. Запустите бота:
```bash
python main.py
```

## Архитектура приложения

### Модели данных (bot/core/models.py)
- `User` - данные пользователя
- `NotificationTemplate` - шаблон уведомления
- `NotificationSetting` - настройка уведомления
- `NotificationLog` - лог отправки уведомлений

### Репозитории (bot/repositories)
Слой доступа к данным, реализующий CRUD операции:
- `DatabaseManager` - управление подключением к БД
- `UserRepository` - операции с пользователями
- `TemplateRepository` - операции с шаблонами
- `NotificationSettingRepository` - операции с настройками
- `NotificationLogRepository` - операции с логами

### Сервисы (bot/services)
Слой бизнес-логики:
- `UserService` - управление пользователями
- `TemplateService` - управление шаблонами
- `NotificationSettingService` - управление настройками
- `NotificationLogService` - управление логами
- `BackupService` - управление резервными копиями
- `NotificationService` - отправка уведомлений

### Обработчики (bot/handlers)
Слой представления и обработки команд:
- `BaseHandler` - базовый класс обработчика
- `UserHandler` - обработка команд для пользователей
- `TemplateHandler` - обработка команд для шаблонов
- `NotificationSettingHandler` - обработка команд для настроек
- `NotificationLogHandler` - обработка команд для логов
- `BackupHandler` - обработка команд для резервных копий
- `GameHandler` - обработка игровых команд
- `NotificationHandler` - обработка команд для уведомлений

## Особенности реализации

### Форматирование сообщений
- Поддержка HTML-тегов в сообщениях
- Правильные падежи для русских месяцев
- Интуитивно понятные emoji в сообщениях
- Предпросмотр шаблонов перед сохранением

### База данных
- Автоматическое создание структуры при первом запуске
- Система миграций и резервного копирования
- Ленивое подключение для экономии ресурсов
- Валидация данных на уровне репозиториев

### Безопасность
- Декораторы для проверки прав доступа
- Валидация пользовательского ввода
- Защита от несанкционированного доступа
- Блокировка множественных запусков бота

### Уведомления
- Настраиваемые интервалы отправки
- Поддержка различных шаблонов
- Система подтверждения подписки
- Отслеживание статуса доставки
- Логирование отправленных уведомлений

## Локализация

Бот полностью локализован на русский язык, включая:
- Все сообщения и команды
- Форматирование дат
- Названия месяцев с правильными падежами
- Системные уведомления
- Сообщения об ошибках
- Административные команды